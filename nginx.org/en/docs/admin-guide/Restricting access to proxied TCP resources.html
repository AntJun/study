<!DOCTYPE html>
<html>
<head>
<title>Restricting access to proxied TCP resources</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">
/* GitHub stylesheet for MarkdownPad (http://markdownpad.com) */
/* Author: Nicolas Hery - http://nicolashery.com */
/* Version: b13fe65ca28d2e568c6ed5d7f06581183df8f2ff */
/* Source: https://github.com/nicolahery/markdownpad-github */

/* RESET
=============================================================================*/

html, body, div, span, applet, object, iframe, h1, h2, h3, h4, h5, h6, p, blockquote, pre, a, abbr, acronym, address, big, cite, code, del, dfn, em, img, ins, kbd, q, s, samp, small, strike, strong, sub, sup, tt, var, b, u, i, center, dl, dt, dd, ol, ul, li, fieldset, form, label, legend, table, caption, tbody, tfoot, thead, tr, th, td, article, aside, canvas, details, embed, figure, figcaption, footer, header, hgroup, menu, nav, output, ruby, section, summary, time, mark, audio, video {
  margin: 0;
  padding: 0;
  border: 0;
}

/* BODY
=============================================================================*/

body {
  font-family: Helvetica, arial, freesans, clean, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  color: #333;
  background-color: #fff;
  padding: 20px;
  max-width: 960px;
  margin: 0 auto;
}

body>*:first-child {
  margin-top: 0 !important;
}

body>*:last-child {
  margin-bottom: 0 !important;
}

/* BLOCKS
=============================================================================*/

p, blockquote, ul, ol, dl, table, pre {
  margin: 15px 0;
}

/* HEADERS
=============================================================================*/

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
}

h1 tt, h1 code, h2 tt, h2 code, h3 tt, h3 code, h4 tt, h4 code, h5 tt, h5 code, h6 tt, h6 code {
  font-size: inherit;
}

h1 {
  font-size: 28px;
  color: #000;
}

h2 {
  font-size: 24px;
  border-bottom: 1px solid #ccc;
  color: #000;
}

h3 {
  font-size: 18px;
}

h4 {
  font-size: 16px;
}

h5 {
  font-size: 14px;
}

h6 {
  color: #777;
  font-size: 14px;
}

body>h2:first-child, body>h1:first-child, body>h1:first-child+h2, body>h3:first-child, body>h4:first-child, body>h5:first-child, body>h6:first-child {
  margin-top: 0;
  padding-top: 0;
}

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0;
}

h1+p, h2+p, h3+p, h4+p, h5+p, h6+p {
  margin-top: 10px;
}

/* LINKS
=============================================================================*/

a {
  color: #4183C4;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* LISTS
=============================================================================*/

ul, ol {
  padding-left: 30px;
}

ul li > :first-child, 
ol li > :first-child, 
ul li ul:first-of-type, 
ol li ol:first-of-type, 
ul li ol:first-of-type, 
ol li ul:first-of-type {
  margin-top: 0px;
}

ul ul, ul ol, ol ol, ol ul {
  margin-bottom: 0;
}

dl {
  padding: 0;
}

dl dt {
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
  padding: 0;
  margin: 15px 0 5px;
}

dl dt:first-child {
  padding: 0;
}

dl dt>:first-child {
  margin-top: 0px;
}

dl dt>:last-child {
  margin-bottom: 0px;
}

dl dd {
  margin: 0 0 15px;
  padding: 0 15px;
}

dl dd>:first-child {
  margin-top: 0px;
}

dl dd>:last-child {
  margin-bottom: 0px;
}

/* CODE
=============================================================================*/

pre, code, tt {
  font-size: 12px;
  font-family: Consolas, "Liberation Mono", Courier, monospace;
}

code, tt {
  margin: 0 0px;
  padding: 0px 0px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px;
}

pre>code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent;
}

pre {
  background-color: #f8f8f8;
  border: 1px solid #ccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px;
}

pre code, pre tt {
  background-color: transparent;
  border: none;
}

kbd {
    -moz-border-bottom-colors: none;
    -moz-border-left-colors: none;
    -moz-border-right-colors: none;
    -moz-border-top-colors: none;
    background-color: #DDDDDD;
    background-image: linear-gradient(#F1F1F1, #DDDDDD);
    background-repeat: repeat-x;
    border-color: #DDDDDD #CCCCCC #CCCCCC #DDDDDD;
    border-image: none;
    border-radius: 2px 2px 2px 2px;
    border-style: solid;
    border-width: 1px;
    font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    line-height: 10px;
    padding: 1px 4px;
}

/* QUOTES
=============================================================================*/

blockquote {
  border-left: 4px solid #DDD;
  padding: 0 15px;
  color: #777;
}

blockquote>:first-child {
  margin-top: 0px;
}

blockquote>:last-child {
  margin-bottom: 0px;
}

/* HORIZONTAL RULES
=============================================================================*/

hr {
  clear: both;
  margin: 15px 0;
  height: 0px;
  overflow: hidden;
  border: none;
  background: transparent;
  border-bottom: 4px solid #ddd;
  padding: 0;
}

/* TABLES
=============================================================================*/

table th {
  font-weight: bold;
}

table th, table td {
  border: 1px solid #ccc;
  padding: 6px 13px;
}

table tr {
  border-top: 1px solid #ccc;
  background-color: #fff;
}

table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

/* IMAGES
=============================================================================*/

img {
  max-width: 100%
}
</style>
</head>
<body>
<p>This section provides scenarios for restricting access to a database or media server that communicates over TCP. Access can be limited by IP address, the number of simultaneous connections, or bandwidth.</p>
<h2 id="toc">In This Section</h2>
<ul>
<li><a href="#restrict">Restricting Access by IP Address</a></li>
<li><a href="#limit_conn">Limiting the Number of TCP Connections</a></li>
<li><a href="#limit_bandwidth">Limiting the Bandwidth</a></li>
</ul>
<h2 id="restrict">Restricting Access by IP Address</h2>
<p>NGINX can allow or deny access based on a particular IP address or the range of IP addresses of client computers. To allow or deny access, use the <code><a href="http://nginx.org/en/docs/stream/ngx_stream_access_module.html#allow">allow</a></code> and <code><a href="http://nginx.org/en/docs/stream/ngx_stream_access_module.html#deny">deny</a></code> directives inside the <code><a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#stream">stream</a></code> context or a <code><a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#server">server</a></code> block:</p>
<pre><code>stream {
    ...
    server {
        listen 12345;
        deny   192.168.1.2;
        allow  192.168.1.1/24;
        allow  2001:0db8::/32;
        deny   all;
    }
}</code></pre>
<p>The rules are processed in sequence, from top to bottom: if the first directive in the sequence is <code>deny all</code>, then all further <code>allow</code> directives have no effect. In this example, the subnet <code>192.168.1.1/24</code> is allowed access, with the exception of <code>192.168.1.2</code>. The <code>2001:0db8::/32</code> range of IPv6 addresses is also allowed, and access to any other IP addresses is denied.</p>
<h2 id="limit_conn">Limiting the Number of TCP Connections</h2>
<p>You can limit the number of simultaneous TCP connections from one IP address. This can be useful in preventing denial-of-service (DoS) attacks.</p>
<p>First, let&#8217;s define the <em>zone</em> that will store the maximum number of TCP connections to one server, and a key to identify the connection. This can be done with the <code><a href="http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone">limit_conn_zone</a></code> directive in the <code><a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#stream">stream</a></code> context:</p>
<pre><code>stream {
    ...
    limit_conn_zone $binary_remote_addr zone=ip_addr:10m;
    ...
}</code></pre>
<p>The key that identifies the connection is defined as <code>$binary_remote_addr</code>, which represents the IP address of the client in binary format. The name of the shared memory zone is <code>ip_addr</code> and the zone size is 10&nbsp;megabytes.</p>
<p>After the zone is defined, limit connections with the <code><a href="http://nginx.org/en/docs/stream/ngx_stream_limit_conn_module.html#limit_conn">limit_conn</a></code> directive. Its first parameter specifies the name of the shared memory zone previously defined by <code><a href="http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone">limit_conn_zone</a></code>. As the second parameter, specify the maximum number of allowed connections for each IP address, in either the <code><a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#stream">stream</a></code> context or a <code><a href="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#server">server</a></code> block (as in this example, which also shows the prerequisite <code>limit_conn_zone</code> directive):</p>
<pre><code>stream {
    ...
    limit_conn_zone $binary_remote_addr zone=ip_addr:10m;

    server {
        ...
        limit_conn ip_addr 1;
    }
}</code></pre>
<p>When limiting the number of connections per IP address, be aware that multiple hosts behind a Network Address Translation (NAT) device share the same IP address.</p>
<h2 id="limit_bandwidth">Limiting the Bandwidth</h2>
<p>You can configure the maximum download or upload speed for TCP connections. Include the <code><a href="http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_download_rate">proxy_download_rate</a></code> or <code><a href="http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html#proxy_upload_rate">proxy_upload_rate</a></code> directive, respectively:</p>
<pre><code>server {
    ...
    proxy_download_rate 100k;
    proxy_upload_rate   50k;
}</code></pre>
<p>With these settings a client can download data through a single connection at a maximum speed of 100 kilobytes per second, and upload data through a single connection at a maximum speed of 50 kilobytes per second. However, the client can open several connections. So if the goal is to limit overall speed of loading for each client, the number of connections must also be limited to <code>1</code> as described in the previous section.</p>
<pre><code>stream {
    ...
    limit_conn_zone $binary_remote_addr zone=ip_addr:10m;

    server {
        ...
        limit_conn ip_addr 1;
        proxy_download_rate 100k;
        proxy_upload_rate   50k;
    }
}</code></pre><p></p></p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
